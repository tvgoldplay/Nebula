# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader", "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".

# See docs/Config_Reference.md for a description of parameters.

#=====================================================
# MACROS
#=====================================================
[include macros.cfg]
[include Fan.cfg]
[include TMC Autotune.cfg]
[exclude_object]
[include TEST_SPEED.cfg]
[include timelapse.cfg]
[include temp_sensors.cfg]
[include z_tilt.cfg]
[include beacon.cfg]
[include LED.cfg]
[include resonance_tester.cfg]
[include input_shaper.cfg]
[include AFC/*.cfg]
[include macro_thermal_expansion_compensation.cfg]

#=====================================================
# VIRTUAL SD CARD
#=====================================================
[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

#=====================================================
# MCU ID
#=====================================================
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3F003D001051313236343430-if00
[mcu EBBCan]
canbus_uuid: e75929009724
[mcu U2C]
canbus_uuid: 2246f0775ddc

####################################################################
# 	X/Y Stepper Settings
#####################################################################

########################################
# X Stepper on Motor1 (A Motor)
########################################
# Motor-1
[stepper_x]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan:PB5
position_endstop: 1
position_max: 377
homing_speed: 150

[tmc5160 stepper_x]
cs_pin: PG14
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# Y Stepper on Motor2 (B Motor)
########################################
# Motor-2
[stepper_y]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 16
rotation_distance: 40
endstop_pin: PF0
position_endstop: 370
position_max: 370
homing_speed: 150

[tmc5160 stepper_y]
cs_pin: PG13
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# STEPPER Z
########################################
# Motor-5 Rear Center
[stepper_z]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
endstop_pin: probe:z_virtual_endstop
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
position_max: 370
position_min: -4
homing_speed: 10
homing_retract_dist: 0

[tmc2209 stepper_z]
interpolate: false
uart_pin: PG10
run_current: 1.0
sense_resistor: 0.11

# Motor-6 Front Left 
[stepper_z1] 
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z1]
interpolate: false
uart_pin: PG9
run_current: 1.0
sense_resistor: 0.11

# motor-7 Front Right
[stepper_z2]
step_pin:PD3
dir_pin: PD2
enable_pin: !PD4
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z2]
interpolate: false
uart_pin: PD7
run_current: 1.0
sense_resistor: 0.11


########################################
# EXTRUDER
########################################
[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 35.8
gear_ratio: 60:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: MAX31865
pwm_cycle_time: 0.00417
sensor_pin: EBBCan: PA4
spi_bus: spi1
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2
min_extrude_temp: 180
min_temp: 0
max_temp: 400
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
full_steps_per_rotation: 200
pressure_advance: 0.03
pressure_advance_smooth_time: 0.03
max_extrude_only_distance: 400 

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: true
run_current: 0.85 
sense_resistor: 0.11 
driver_HEND: 6
driver_HSTRT: 7

########################################
# BED MESH
########################################
[bed_mesh]
algorithm: bicubic
speed: 600
mesh_min: 50,50
mesh_max: 330,330
probe_count: 25,25

########################################
# IDLE TIMEOUT
########################################
[idle_timeout]
timeout: 172800

########################################
# HEATER BED
########################################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_kp: 27
#pid_ki: 0.08
#pid_kd: 0
min_temp: 0
max_temp: 120

#=====================================================
# Force Move
#=====================================================
[force_move]
enable_force_move: True

#=====================================================
# PRINTER LIMITS
#=====================================================
[printer]
kinematics: corexy
max_velocity: 800
max_accel: 10000
max_z_velocity: 10
max_z_accel: 300
square_corner_velocity: 5.0

[save_variables]
filename: ~/printer_data/config/variables.txt

#=====================================================
# SHAKETUNE
#=====================================================
[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_version = 1
#*# pid_target = 290.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 19.556
#*# pid_ki = 2.155
#*# pid_kd = 44.371
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 30.789
#*# pid_ki = 0.901
#*# pid_kd = 263.053
#*#
#*# [beacon model default]
#*# model_coef = 1.3932691026319752,
#*# 	  1.7132478599992236,
#*# 	  0.7201989817595704,
#*# 	  0.2774646523484808,
#*# 	  0.4311925063912027,
#*# 	  0.7005687770220815,
#*# 	  -0.12317384253246111,
#*# 	  -0.6546685278093134,
#*# 	  0.17797675009660108,
#*# 	  0.3661137500105821
#*# model_domain = 1.7840694268844254e-07,1.9275301798673233e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 75.010856
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.026639, 0.034816, 0.042299, 0.048461, 0.052988, 0.059343, 0.067243, 0.073012, 0.076544, 0.076930, 0.071151, 0.070581, 0.068099, 0.065845, 0.062647, 0.057070, 0.051252, 0.046207, 0.038785, 0.031260, 0.023675, 0.016300, 0.011403, 0.007036, -0.000594
#*# 	0.043078, 0.051807, 0.058170, 0.063722, 0.068319, 0.073174, 0.078608, 0.084280, 0.087893, 0.087806, 0.086249, 0.084471, 0.082008, 0.079895, 0.077532, 0.075177, 0.070483, 0.064536, 0.057626, 0.050209, 0.045861, 0.039250, 0.035233, 0.025254, 0.016837
#*# 	0.055567, 0.062892, 0.068988, 0.076292, 0.083170, 0.087319, 0.092512, 0.095153, 0.099259, 0.100907, 0.101831, 0.102203, 0.101058, 0.099608, 0.094331, 0.091998, 0.087160, 0.084841, 0.077902, 0.070105, 0.064219, 0.057855, 0.050102, 0.042243, 0.034053
#*# 	0.069237, 0.079342, 0.085609, 0.093074, 0.097735, 0.103072, 0.108978, 0.112203, 0.114487, 0.116939, 0.118903, 0.118774, 0.119007, 0.116852, 0.113575, 0.109903, 0.107711, 0.101097, 0.093528, 0.082848, 0.074723, 0.068820, 0.060211, 0.057009, 0.048436
#*# 	0.077662, 0.089397, 0.096696, 0.103580, 0.109053, 0.114947, 0.117797, 0.120502, 0.120900, 0.126002, 0.129967, 0.131197, 0.131121, 0.128505, 0.128004, 0.127789, 0.123424, 0.117285, 0.106826, 0.095228, 0.085873, 0.080529, 0.076270, 0.071824, 0.066152
#*# 	0.081906, 0.091852, 0.099300, 0.105335, 0.113620, 0.119730, 0.124395, 0.126845, 0.130514, 0.134323, 0.137840, 0.141708, 0.141570, 0.138601, 0.137229, 0.136548, 0.132476, 0.127200, 0.117480, 0.105959, 0.095365, 0.087635, 0.082939, 0.079083, 0.071814
#*# 	0.082753, 0.093005, 0.102436, 0.110905, 0.117626, 0.124424, 0.131020, 0.135936, 0.138390, 0.143900, 0.146944, 0.149938, 0.150027, 0.147798, 0.145712, 0.143850, 0.142058, 0.135770, 0.127070, 0.114211, 0.103527, 0.093159, 0.086834, 0.082970, 0.075569
#*# 	0.080651, 0.092710, 0.101137, 0.111523, 0.118757, 0.127204, 0.135669, 0.141101, 0.145968, 0.153311, 0.157491, 0.162339, 0.162732, 0.160281, 0.159402, 0.157813, 0.151012, 0.144300, 0.133683, 0.119757, 0.109123, 0.100952, 0.095210, 0.087085, 0.079656
#*# 	0.088819, 0.100435, 0.107310, 0.113653, 0.120813, 0.129952, 0.140932, 0.148251, 0.155931, 0.160790, 0.166172, 0.170436, 0.169410, 0.166875, 0.164941, 0.162326, 0.155755, 0.149911, 0.140182, 0.128684, 0.117309, 0.107321, 0.100322, 0.092099, 0.085674
#*# 	0.091699, 0.100355, 0.106090, 0.113023, 0.121471, 0.129397, 0.142051, 0.151341, 0.155974, 0.161392, 0.165969, 0.167472, 0.168143, 0.165752, 0.164967, 0.161734, 0.159067, 0.152750, 0.144241, 0.135140, 0.125161, 0.117525, 0.106942, 0.102562, 0.091995
#*# 	0.094116, 0.102379, 0.109584, 0.116173, 0.123529, 0.133839, 0.144861, 0.155664, 0.162309, 0.165713, 0.169117, 0.170374, 0.172453, 0.171066, 0.169984, 0.167290, 0.163621, 0.156952, 0.148519, 0.141862, 0.132500, 0.123758, 0.115942, 0.110365, 0.100683
#*# 	0.088335, 0.098314, 0.107805, 0.114979, 0.122798, 0.132043, 0.143117, 0.153979, 0.160149, 0.164568, 0.166383, 0.169314, 0.169992, 0.168689, 0.168276, 0.166752, 0.163356, 0.158278, 0.151430, 0.144549, 0.133526, 0.126267, 0.119798, 0.110951, 0.101679
#*# 	0.087424, 0.096168, 0.101868, 0.109017, 0.117127, 0.126977, 0.139255, 0.152443, 0.160178, 0.163708, 0.163945, 0.163329, 0.162748, 0.160412, 0.162524, 0.163456, 0.160132, 0.154803, 0.146858, 0.138868, 0.129934, 0.121875, 0.115055, 0.106778, 0.097583
#*# 	0.083696, 0.090009, 0.097059, 0.103151, 0.111144, 0.122820, 0.137281, 0.148326, 0.153529, 0.157173, 0.157042, 0.158509, 0.159409, 0.159453, 0.158594, 0.155571, 0.149989, 0.145111, 0.138195, 0.128897, 0.123001, 0.113027, 0.104542, 0.098532, 0.088079
#*# 	0.080430, 0.087666, 0.096316, 0.101573, 0.110131, 0.125434, 0.138406, 0.148525, 0.155300, 0.159218, 0.159092, 0.159929, 0.159924, 0.159186, 0.157916, 0.153183, 0.147009, 0.140297, 0.133711, 0.125497, 0.116815, 0.110327, 0.104045, 0.098571, 0.090912
#*# 	0.077502, 0.084971, 0.091447, 0.096779, 0.106230, 0.118340, 0.131968, 0.142647, 0.149871, 0.152121, 0.154195, 0.156028, 0.155135, 0.155863, 0.153766, 0.152072, 0.145535, 0.138014, 0.129772, 0.120699, 0.112580, 0.105801, 0.101861, 0.094213, 0.085293
#*# 	0.067434, 0.075125, 0.082029, 0.088067, 0.097842, 0.110233, 0.123518, 0.134304, 0.140534, 0.143030, 0.146163, 0.148344, 0.147051, 0.146171, 0.145422, 0.140501, 0.134847, 0.125022, 0.114187, 0.105225, 0.098792, 0.092908, 0.088067, 0.082293, 0.071508
#*# 	0.058193, 0.064018, 0.071001, 0.076962, 0.086206, 0.100409, 0.114685, 0.125695, 0.130394, 0.134062, 0.134680, 0.137148, 0.139176, 0.138396, 0.137302, 0.132553, 0.126366, 0.119039, 0.109263, 0.101218, 0.092226, 0.087195, 0.080916, 0.074495, 0.063327
#*# 	0.057162, 0.064529, 0.070802, 0.076877, 0.085462, 0.098812, 0.109338, 0.116911, 0.124517, 0.129244, 0.131753, 0.134499, 0.136506, 0.134993, 0.133355, 0.128169, 0.119109, 0.111209, 0.104003, 0.097769, 0.089502, 0.082925, 0.076196, 0.070294, 0.062454
#*# 	0.050380, 0.057221, 0.063548, 0.069606, 0.076542, 0.088317, 0.098705, 0.108769, 0.116100, 0.119552, 0.121024, 0.120478, 0.122572, 0.121559, 0.120775, 0.115889, 0.108513, 0.101403, 0.094477, 0.088467, 0.080884, 0.075081, 0.069276, 0.063292, 0.053507
#*# 	0.036248, 0.042994, 0.048848, 0.057003, 0.064448, 0.074498, 0.083975, 0.092352, 0.099861, 0.105565, 0.107661, 0.110157, 0.110381, 0.106953, 0.103357, 0.100127, 0.094373, 0.086010, 0.080827, 0.073802, 0.067064, 0.060104, 0.053709, 0.048851, 0.043450
#*# 	0.024551, 0.035561, 0.042621, 0.047208, 0.056377, 0.064086, 0.073863, 0.082371, 0.090444, 0.094352, 0.094489, 0.097223, 0.095203, 0.091886, 0.089524, 0.087971, 0.082183, 0.074106, 0.068198, 0.061800, 0.054835, 0.050327, 0.042896, 0.037585, 0.031731
#*# 	0.008935, 0.020434, 0.029284, 0.035910, 0.043718, 0.052195, 0.061530, 0.070288, 0.076437, 0.078489, 0.080283, 0.082292, 0.080528, 0.080552, 0.078377, 0.076028, 0.070000, 0.065246, 0.057600, 0.048909, 0.041183, 0.037389, 0.030855, 0.026135, 0.019052
#*# 	-0.006173, 0.002326, 0.011183, 0.021062, 0.030803, 0.040132, 0.050786, 0.058896, 0.062632, 0.065090, 0.067284, 0.067620, 0.066958, 0.064943, 0.062335, 0.059540, 0.056983, 0.051091, 0.040586, 0.032931, 0.028139, 0.024218, 0.017463, 0.012370, 0.006749
#*# 	-0.015564, -0.006736, 0.001483, 0.011812, 0.024101, 0.033157, 0.041820, 0.050785, 0.057676, 0.060378, 0.060679, 0.061033, 0.060588, 0.058718, 0.055416, 0.052723, 0.047312, 0.039685, 0.032048, 0.025625, 0.018153, 0.017349, 0.012085, 0.005784, 0.000715
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 330.0
#*# min_y = 50.0
#*# max_y = 330.0
