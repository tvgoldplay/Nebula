# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader", "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".

# See docs/Config_Reference.md for a description of parameters.

#=====================================================
# MACROS
#=====================================================
[include macros.cfg]
[include Fan.cfg]
[include TMC Autotune.cfg]
[exclude_object]
[include TEST_SPEED.cfg]
[include timelapse.cfg]
[include temp_sensors.cfg]
[include z_tilt.cfg]
[include beacon.cfg]
[include LED.cfg]
[include resonance_tester.cfg]
[include input_shaper.cfg]
[include AFC/*.cfg]
[include macro_thermal_expansion_compensation.cfg]

#=====================================================
# VIRTUAL SD CARD
#=====================================================
[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

#=====================================================
# MCU ID
#=====================================================
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3F003D001051313236343430-if00
[mcu EBBCan]
canbus_uuid: e75929009724
[mcu U2C]
canbus_uuid: 2246f0775ddc

####################################################################
# 	X/Y Stepper Settings
#####################################################################

########################################
# X Stepper on Motor1 (A Motor)
########################################
# Motor-1
[stepper_x]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan:PB5
position_endstop: 1
position_max: 377
homing_speed: 150

[tmc5160 stepper_x]
cs_pin: PG14
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# Y Stepper on Motor2 (B Motor)
########################################
# Motor-2
[stepper_y]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 16
rotation_distance: 40
endstop_pin: PF0
position_endstop: 370
position_max: 370
homing_speed: 150

[tmc5160 stepper_y]
cs_pin: PG13
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# STEPPER Z
########################################
# Motor-5 Rear Center
[stepper_z]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
endstop_pin: probe:z_virtual_endstop
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
position_max: 370
position_min: -4
homing_speed: 10
homing_retract_dist: 0

[tmc2209 stepper_z]
interpolate: false
uart_pin: PG10
run_current: 1.0
sense_resistor: 0.11

# Motor-6 Front Left 
[stepper_z1] 
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z1]
interpolate: false
uart_pin: PG9
run_current: 1.0
sense_resistor: 0.11

# motor-7 Front Right
[stepper_z2]
step_pin:PD3
dir_pin: PD2
enable_pin: !PD4
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z2]
interpolate: false
uart_pin: PD7
run_current: 1.0
sense_resistor: 0.11


########################################
# EXTRUDER
########################################
[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 35.8
gear_ratio: 60:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: MAX31865
pwm_cycle_time: 0.00417
sensor_pin: EBBCan: PA4
spi_bus: spi1
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2
min_extrude_temp: 180
min_temp: 0
max_temp: 400
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
full_steps_per_rotation: 200
pressure_advance: 0.03
pressure_advance_smooth_time: 0.03
max_extrude_only_distance: 400 

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: true
run_current: 0.85 
sense_resistor: 0.11 
driver_HEND: 6
driver_HSTRT: 7

########################################
# BED MESH
########################################
[bed_mesh]
algorithm: bicubic
speed: 600
mesh_min: 50,50
mesh_max: 330,330
probe_count: 25,25

########################################
# IDLE TIMEOUT
########################################
[idle_timeout]
timeout: 172800

########################################
# HEATER BED
########################################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_kp: 27
#pid_ki: 0.08
#pid_kd: 0
min_temp: 0
max_temp: 120

#=====================================================
# Force Move
#=====================================================
[force_move]
enable_force_move: True

#=====================================================
# PRINTER LIMITS
#=====================================================
[printer]
kinematics: corexy
max_velocity: 800
max_accel: 10000
max_z_velocity: 10
max_z_accel: 300
square_corner_velocity: 5.0

[save_variables]
filename: ~/printer_data/config/variables.txt

#=====================================================
# SHAKETUNE
#=====================================================
[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_version = 1
#*# pid_target = 290.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 19.556
#*# pid_ki = 2.155
#*# pid_kd = 44.371
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 30.789
#*# pid_ki = 0.901
#*# pid_kd = 263.053
#*#
#*# [beacon model default]
#*# model_coef = 1.3988707334656276,
#*# 	  1.7142749273165023,
#*# 	  0.7425914087253896,
#*# 	  0.3211235096172254,
#*# 	  0.39862079617769514,
#*# 	  0.5868215357999401,
#*# 	  -0.1477368212889442,
#*# 	  -0.559723466840108,
#*# 	  0.20708298189595578,
#*# 	  0.3405064928844832
#*# model_domain = 1.7885285826168298e-07,1.927620787722543e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 69.768586
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.024784, 0.030716, 0.035775, 0.041863, 0.046960, 0.052571, 0.055979, 0.059680, 0.063744, 0.065745, 0.067604, 0.066362, 0.063198, 0.060866, 0.057435, 0.055768, 0.051569, 0.045227, 0.041426, 0.034669, 0.027476, 0.021723, 0.018315, 0.012570, 0.004030
#*# 	0.042730, 0.047455, 0.053127, 0.058954, 0.066096, 0.071464, 0.074689, 0.078928, 0.082135, 0.085581, 0.086171, 0.083991, 0.081638, 0.079881, 0.078084, 0.074788, 0.070536, 0.064720, 0.058139, 0.052820, 0.046727, 0.040825, 0.035259, 0.027108, 0.020026
#*# 	0.052708, 0.059559, 0.065159, 0.071585, 0.076360, 0.081536, 0.085971, 0.088971, 0.091756, 0.096249, 0.098948, 0.098470, 0.098656, 0.096220, 0.095073, 0.092197, 0.088310, 0.079947, 0.071149, 0.064915, 0.058709, 0.053267, 0.047593, 0.044229, 0.036387
#*# 	0.060658, 0.069216, 0.075752, 0.079797, 0.084043, 0.089635, 0.093057, 0.096284, 0.100791, 0.106142, 0.111306, 0.110662, 0.110608, 0.111021, 0.109826, 0.106265, 0.102498, 0.093250, 0.085182, 0.077808, 0.070088, 0.064396, 0.059188, 0.054784, 0.049432
#*# 	0.075156, 0.082620, 0.088522, 0.092309, 0.097867, 0.102316, 0.105115, 0.109659, 0.113913, 0.120211, 0.123829, 0.125241, 0.125345, 0.126226, 0.125373, 0.122060, 0.116086, 0.107323, 0.098636, 0.090197, 0.082298, 0.078378, 0.074124, 0.071162, 0.067146
#*# 	0.081800, 0.090816, 0.098578, 0.103380, 0.109348, 0.113149, 0.116854, 0.120280, 0.124409, 0.131555, 0.135672, 0.138286, 0.137974, 0.138601, 0.136156, 0.132258, 0.125285, 0.116681, 0.108413, 0.099893, 0.091962, 0.088079, 0.083648, 0.080649, 0.074995
#*# 	0.086838, 0.094030, 0.101288, 0.107392, 0.113678, 0.119461, 0.124779, 0.129170, 0.131983, 0.138914, 0.141960, 0.143324, 0.143612, 0.142454, 0.142906, 0.139594, 0.134059, 0.125887, 0.114893, 0.106009, 0.098273, 0.093541, 0.090334, 0.088458, 0.082672
#*# 	0.091280, 0.099437, 0.107313, 0.113158, 0.119396, 0.126639, 0.133380, 0.139588, 0.144038, 0.150052, 0.152279, 0.154477, 0.155836, 0.154141, 0.152635, 0.149470, 0.144359, 0.135523, 0.125066, 0.115184, 0.105766, 0.100639, 0.097942, 0.093377, 0.087361
#*# 	0.098781, 0.107817, 0.115691, 0.122514, 0.126325, 0.131219, 0.137540, 0.143939, 0.151235, 0.159017, 0.161967, 0.163321, 0.163625, 0.162013, 0.161017, 0.157370, 0.148783, 0.141076, 0.132467, 0.121116, 0.111033, 0.105789, 0.102400, 0.098009, 0.090576
#*# 	0.099116, 0.106866, 0.114328, 0.121831, 0.125643, 0.130068, 0.138296, 0.146494, 0.152774, 0.158287, 0.162180, 0.163290, 0.164697, 0.166703, 0.165279, 0.159405, 0.152193, 0.142986, 0.134830, 0.126257, 0.118259, 0.111902, 0.105365, 0.100722, 0.093502
#*# 	0.101968, 0.111075, 0.118640, 0.125165, 0.128748, 0.132824, 0.139419, 0.148274, 0.155537, 0.159511, 0.162171, 0.165451, 0.166007, 0.167011, 0.163932, 0.159426, 0.153223, 0.143793, 0.136403, 0.129745, 0.123459, 0.118380, 0.112631, 0.106228, 0.097703
#*# 	0.104985, 0.111837, 0.118155, 0.121843, 0.127753, 0.132886, 0.140658, 0.146196, 0.152284, 0.156472, 0.156490, 0.158329, 0.160752, 0.162009, 0.161732, 0.159314, 0.151904, 0.143148, 0.138121, 0.135314, 0.129745, 0.123229, 0.116979, 0.110810, 0.103029
#*# 	0.104368, 0.110763, 0.115720, 0.120517, 0.126931, 0.133606, 0.141154, 0.146247, 0.150152, 0.152065, 0.152823, 0.152472, 0.154697, 0.154014, 0.153264, 0.151588, 0.146791, 0.139091, 0.132473, 0.128459, 0.121844, 0.116968, 0.110947, 0.105924, 0.098754
#*# 	0.095646, 0.101761, 0.106263, 0.110181, 0.117183, 0.126099, 0.136950, 0.143666, 0.146042, 0.147018, 0.147484, 0.148243, 0.148392, 0.146651, 0.144872, 0.143826, 0.139001, 0.133132, 0.124716, 0.118924, 0.114611, 0.112050, 0.109049, 0.102772, 0.093856
#*# 	0.095905, 0.102292, 0.104423, 0.107301, 0.116132, 0.128181, 0.138925, 0.143761, 0.145303, 0.146277, 0.147372, 0.148617, 0.148264, 0.146517, 0.147853, 0.147125, 0.141966, 0.132299, 0.123008, 0.115588, 0.108194, 0.105295, 0.101935, 0.096964, 0.090116
#*# 	0.091054, 0.095911, 0.099237, 0.103584, 0.112584, 0.125215, 0.135974, 0.140749, 0.143502, 0.142564, 0.141302, 0.142117, 0.141902, 0.140074, 0.140575, 0.141144, 0.137359, 0.127921, 0.117542, 0.109673, 0.102667, 0.098178, 0.095967, 0.092405, 0.084522
#*# 	0.079479, 0.083270, 0.086843, 0.092418, 0.101135, 0.113282, 0.123476, 0.129958, 0.131751, 0.131702, 0.131555, 0.132779, 0.132528, 0.132332, 0.131636, 0.129474, 0.126729, 0.120348, 0.109834, 0.098933, 0.089910, 0.085096, 0.082023, 0.077898, 0.071178
#*# 	0.068993, 0.072393, 0.078861, 0.086262, 0.096235, 0.107573, 0.117026, 0.121954, 0.124415, 0.126327, 0.126168, 0.127544, 0.126802, 0.125042, 0.123001, 0.120776, 0.117163, 0.109859, 0.100075, 0.090478, 0.081989, 0.075681, 0.071279, 0.066671, 0.060555
#*# 	0.063911, 0.068408, 0.077098, 0.084957, 0.096112, 0.105583, 0.111672, 0.118867, 0.124442, 0.126285, 0.127152, 0.127756, 0.126010, 0.124999, 0.124296, 0.120732, 0.114362, 0.108168, 0.100723, 0.091327, 0.080622, 0.075798, 0.072010, 0.065934, 0.058152
#*# 	0.054412, 0.060303, 0.067751, 0.075425, 0.083970, 0.093139, 0.101020, 0.108532, 0.114531, 0.119077, 0.120837, 0.120198, 0.117281, 0.114339, 0.113366, 0.110895, 0.107098, 0.100252, 0.091125, 0.080861, 0.074307, 0.070114, 0.064490, 0.057718, 0.050423
#*# 	0.039984, 0.046201, 0.052768, 0.063226, 0.071733, 0.081047, 0.088880, 0.096224, 0.101988, 0.106806, 0.110051, 0.109930, 0.107638, 0.102795, 0.100071, 0.097622, 0.093281, 0.084094, 0.074656, 0.064480, 0.056976, 0.052839, 0.047556, 0.042174, 0.034387
#*# 	0.026229, 0.036384, 0.046921, 0.055719, 0.065083, 0.073958, 0.080849, 0.086785, 0.091970, 0.095034, 0.095916, 0.098628, 0.098337, 0.095286, 0.095505, 0.091888, 0.084857, 0.073269, 0.062476, 0.054037, 0.047609, 0.043277, 0.035292, 0.034668, 0.026880
#*# 	0.014830, 0.023125, 0.033595, 0.043161, 0.050671, 0.060956, 0.069271, 0.076764, 0.082180, 0.083398, 0.083611, 0.084715, 0.085547, 0.086602, 0.086213, 0.081332, 0.073084, 0.062919, 0.051089, 0.040740, 0.035447, 0.031155, 0.028015, 0.022568, 0.017231
#*# 	0.003381, 0.011351, 0.023546, 0.032821, 0.040376, 0.050147, 0.059913, 0.065929, 0.066651, 0.069140, 0.070510, 0.070036, 0.070351, 0.070428, 0.069561, 0.065052, 0.059725, 0.052170, 0.040527, 0.030594, 0.024829, 0.021412, 0.015709, 0.010812, 0.002787
#*# 	-0.009264, 0.000703, 0.011445, 0.021145, 0.030594, 0.039504, 0.047703, 0.056543, 0.059841, 0.062332, 0.062268, 0.062049, 0.060855, 0.058719, 0.057048, 0.055649, 0.050282, 0.044331, 0.034475, 0.025132, 0.019997, 0.015685, 0.013333, 0.004888, -0.000006
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 330.0
#*# min_y = 50.0
#*# max_y = 330.0
