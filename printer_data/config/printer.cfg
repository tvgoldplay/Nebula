# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader", "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".

# See docs/Config_Reference.md for a description of parameters.

#=====================================================
# MACROS
#=====================================================
[include macros.cfg]
[include Fan.cfg]
[include TMC Autotune.cfg]
[exclude_object]
[include TEST_SPEED.cfg]
[include timelapse.cfg]
[include temp_sensors.cfg]
[include z_tilt.cfg]
[include beacon.cfg]
[include LED.cfg]
[include resonance_tester.cfg]
[include input_shaper.cfg]
[include AFC/*.cfg]
#=====================================================
# ARCS SUPPORT
#=====================================================
[gcode_arcs]
resolution: 0.1

#====================================================0=
# VIRTUAL SD CARD
#=====================================================
[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

#=====================================================
# MCU ID
#=====================================================
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3F003D001051313236343430-if00
[mcu EBBCan]
canbus_uuid: e75929009724
[mcu U2C]
canbus_uuid: 2246f0775ddc

####################################################################
# 	X/Y Stepper Settings
#####################################################################

########################################
# X Stepper on Motor1 (A Motor)
########################################
# Motor-1
[stepper_a]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan:PB5
position_endstop: 1
position_max: 377
homing_speed: 150

[tmc5160 stepper_a]
cs_pin: PG14
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# Y Stepper on Motor2 (B Motor)
########################################
# Motor-2
[stepper_b]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 16
rotation_distance: 40
endstop_pin: PF0
position_endstop: 370
position_max: 370
homing_speed: 150

[tmc5160 stepper_b]
cs_pin: PG13
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# C Stepper on Motor3 (C Motor)
########################################

[stepper_c]
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
microsteps: 16
rotation_distance: 40
position_endstop: 370
position_max: 370
endstop_pin: PF4
homing_speed: 150

[tmc5160 stepper_c]
cs_pin: PG12
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
sense_resistor: 0.075
interpolate: false

########################################
# C1 Stepper on Motor4 (C1 Motor)
########################################

[stepper_c1]
step_pin: PB8
dir_pin: PB9
enable_pin: !PB7
microsteps: 16
rotation_distance: 40

[tmc5160 stepper_c1]
cs_pin: PG11
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
sense_resistor: 0.075
interpolate: false

########################################
# STEPPER Z
########################################
# Motor-5 Rear Center
[stepper_z]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
endstop_pin: probe:z_virtual_endstop
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
position_max: 370
position_min: -4
homing_speed: 10
homing_retract_dist: 0

[tmc2209 stepper_z]
interpolate: false
uart_pin: PG10
run_current: 1.0
sense_resistor: 0.11

# Motor-6 Front Left 
[stepper_z1] 
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z1]
interpolate: false
uart_pin: PG9
run_current: 1.0
sense_resistor: 0.11

# motor-7 Front Right
[stepper_z2]
step_pin:PD3
dir_pin: PD2
enable_pin: !PD4
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z2]
interpolate: false
uart_pin: PD7
run_current: 1.0
sense_resistor: 0.11

########################################
# EXTRUDER
########################################
[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 35.1
gear_ratio: 60:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: MAX31865
pwm_cycle_time: 0.00417
sensor_pin: EBBCan: PA4
spi_bus: spi1
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2
min_extrude_temp: 180
min_temp: 0
max_temp: 400
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
full_steps_per_rotation: 200
pressure_advance: 0.031
pressure_advance_smooth_time: 0.02
max_extrude_only_distance: 400 

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: false
run_current: 0.85 
sense_resistor: 0.11 
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

########################################
# BED MESH
########################################
[bed_mesh]
algorithm: bicubic
speed: 600
mesh_min: 50,50
mesh_max: 330,330
probe_count: 100,100

########################################
# IDLE TIMEOUT
########################################
[idle_timeout]
timeout: 172800

########################################
# HEATER BED
########################################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_kp: 27
#pid_ki: 0.08
#pid_kd: 0
min_temp: 0
max_temp: 120

#=====================================================
# Force Move
#=====================================================
[force_move]
enable_force_move: True

#=====================================================
# PRINTER LIMITS
#=====================================================
[printer]
kinematics: extended_corexy
home_y_axis_with_b_rail : True
max_velocity: 800
max_accel: 10000
max_z_velocity: 10
max_z_accel: 300
square_corner_velocity: 5.0

#=====================================================
# SHAKETUNE
#=====================================================
[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_version = 1
#*# pid_target = 200.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 21.057
#*# pid_ki = 2.455
#*# pid_kd = 45.144
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 57.434
#*# pid_ki = 2.413
#*# pid_kd = 341.734
#*#
#*# [beacon model default]
#*# model_coef = 1.3943543696779073,
#*# 	  1.740015472358972,
#*# 	  0.7761274122346037,
#*# 	  0.23357268509773957,
#*# 	  0.3073982779491997,
#*# 	  0.7564480610610829,
#*# 	  0.08709593707735912,
#*# 	  -0.601896463481624,
#*# 	  0.034203042746139285,
#*# 	  0.27387083824246233
#*# model_domain = 1.785915990462568e-07,1.9262551709532037e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 36.868425
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.006789, 0.004728, 0.003948, -0.000474, -0.005417, -0.007128, -0.005762, -0.005063, -0.004835, -0.008944, -0.014930, -0.018692, -0.020897, -0.023262, -0.025012, -0.026861, -0.025654, -0.024417, -0.026516, -0.028453, -0.028488, -0.021096, -0.012634, -0.004811, -0.001315
#*# 	  0.018120, 0.018072, 0.015392, 0.008332, 0.003347, 0.001116, 0.001040, 0.001912, 0.001378, -0.002592, -0.006355, -0.009450, -0.011955, -0.013567, -0.014566, -0.013834, -0.011402, -0.011723, -0.013205, -0.014063, -0.011686, -0.002716, 0.005034, 0.009484, 0.014102
#*# 	  0.029003, 0.025529, 0.020862, 0.017240, 0.012789, 0.010191, 0.011746, 0.010806, 0.008586, 0.005602, 0.003840, 0.002469, 0.001996, -0.000622, -0.001944, -0.000758, 0.001915, 0.003267, 0.001208, -0.000900, 0.001911, 0.009680, 0.016419, 0.021495, 0.022529
#*# 	  0.035436, 0.037318, 0.035434, 0.029616, 0.023355, 0.021535, 0.023517, 0.021798, 0.018826, 0.016962, 0.016831, 0.015404, 0.015482, 0.014127, 0.011096, 0.013488, 0.015322, 0.014878, 0.011576, 0.005946, 0.007145, 0.014591, 0.023187, 0.030476, 0.028799
#*# 	  0.040796, 0.043906, 0.040858, 0.035184, 0.031899, 0.029479, 0.029436, 0.026546, 0.022303, 0.022433, 0.023330, 0.024365, 0.024000, 0.022431, 0.022438, 0.026661, 0.027449, 0.025705, 0.021738, 0.015139, 0.014801, 0.023332, 0.033323, 0.040679, 0.043719
#*# 	  0.042523, 0.044121, 0.041193, 0.037213, 0.033313, 0.031768, 0.032057, 0.030216, 0.028844, 0.028017, 0.028982, 0.031388, 0.031150, 0.028587, 0.029133, 0.031559, 0.033331, 0.033767, 0.028798, 0.021699, 0.020704, 0.027079, 0.036873, 0.045063, 0.047103
#*# 	  0.040995, 0.043750, 0.042641, 0.040359, 0.035877, 0.035087, 0.036629, 0.036390, 0.034378, 0.035035, 0.035072, 0.036238, 0.036582, 0.035017, 0.033615, 0.036808, 0.038995, 0.039308, 0.035562, 0.028436, 0.025713, 0.029531, 0.037588, 0.044516, 0.045815
#*# 	  0.038934, 0.042943, 0.041643, 0.038465, 0.035137, 0.036189, 0.039332, 0.041044, 0.040476, 0.041970, 0.043368, 0.046428, 0.046485, 0.044693, 0.045057, 0.047594, 0.046209, 0.043067, 0.040105, 0.031820, 0.028932, 0.034177, 0.041982, 0.047137, 0.049384
#*# 	  0.045977, 0.049012, 0.045869, 0.041458, 0.036751, 0.037461, 0.042719, 0.046887, 0.048276, 0.047838, 0.049681, 0.051959, 0.050695, 0.048322, 0.048527, 0.050376, 0.049185, 0.048702, 0.044661, 0.038070, 0.034809, 0.039511, 0.046658, 0.050756, 0.054066
#*# 	  0.046967, 0.048031, 0.045451, 0.040196, 0.035742, 0.037008, 0.043758, 0.049049, 0.048571, 0.047938, 0.049304, 0.048890, 0.048886, 0.047476, 0.047584, 0.048422, 0.050338, 0.050479, 0.046704, 0.042554, 0.041682, 0.046888, 0.052106, 0.057039, 0.057619
#*# 	  0.050368, 0.051447, 0.048554, 0.043487, 0.039092, 0.041301, 0.046966, 0.053512, 0.053869, 0.052871, 0.052366, 0.050642, 0.052458, 0.051527, 0.051430, 0.053004, 0.054888, 0.053590, 0.049797, 0.047300, 0.047146, 0.052186, 0.058255, 0.063810, 0.063379
#*# 	  0.045472, 0.047999, 0.047277, 0.041729, 0.037772, 0.039858, 0.046029, 0.051363, 0.051664, 0.051517, 0.049482, 0.049584, 0.050311, 0.048469, 0.048933, 0.051839, 0.053991, 0.054134, 0.051983, 0.049081, 0.048525, 0.053809, 0.060894, 0.065044, 0.063998
#*# 	  0.043665, 0.045904, 0.042235, 0.037296, 0.034066, 0.035657, 0.043240, 0.051683, 0.052167, 0.050661, 0.047795, 0.045665, 0.043951, 0.040882, 0.043096, 0.048997, 0.051975, 0.052079, 0.048373, 0.044894, 0.044815, 0.051449, 0.057488, 0.060790, 0.059115
#*# 	  0.042211, 0.043931, 0.041312, 0.034397, 0.030975, 0.033569, 0.043064, 0.049386, 0.049472, 0.046670, 0.043232, 0.042733, 0.041736, 0.039108, 0.040851, 0.042526, 0.042713, 0.044189, 0.041163, 0.036480, 0.036985, 0.041887, 0.047666, 0.051408, 0.051904
#*# 	  0.045676, 0.041958, 0.040786, 0.033468, 0.029915, 0.036373, 0.044273, 0.050342, 0.051603, 0.049576, 0.045598, 0.044889, 0.043587, 0.042308, 0.041779, 0.041907, 0.041135, 0.039788, 0.037110, 0.032983, 0.033043, 0.040675, 0.048170, 0.054180, 0.055037
#*# 	  0.039551, 0.040379, 0.037856, 0.030449, 0.026660, 0.031876, 0.041517, 0.048507, 0.048035, 0.044818, 0.043371, 0.043194, 0.041424, 0.041787, 0.040679, 0.042480, 0.040882, 0.038534, 0.034701, 0.030023, 0.030694, 0.036645, 0.046378, 0.051854, 0.048469
#*# 	  0.032492, 0.033922, 0.029972, 0.024679, 0.022376, 0.026808, 0.035190, 0.041257, 0.040768, 0.038304, 0.037575, 0.037395, 0.035267, 0.034766, 0.034777, 0.033053, 0.032231, 0.028016, 0.020077, 0.017303, 0.019207, 0.027154, 0.035523, 0.041697, 0.039091
#*# 	  0.026348, 0.027913, 0.023684, 0.016758, 0.012938, 0.019540, 0.028216, 0.033998, 0.034592, 0.031750, 0.028964, 0.028913, 0.029924, 0.029546, 0.028896, 0.028365, 0.026958, 0.023944, 0.018597, 0.014777, 0.014486, 0.022939, 0.031043, 0.034985, 0.033260
#*# 	  0.028976, 0.030263, 0.027906, 0.020059, 0.015856, 0.021609, 0.027193, 0.031520, 0.032587, 0.031048, 0.029387, 0.030512, 0.030462, 0.029721, 0.029262, 0.026986, 0.023381, 0.020278, 0.018019, 0.015036, 0.014279, 0.022673, 0.030778, 0.035264, 0.030919
#*# 	  0.024129, 0.027544, 0.024163, 0.017330, 0.012666, 0.015345, 0.021524, 0.027621, 0.027940, 0.026507, 0.023265, 0.022290, 0.021878, 0.021413, 0.020910, 0.019626, 0.017341, 0.014699, 0.013124, 0.010113, 0.011133, 0.019339, 0.027197, 0.032154, 0.030128
#*# 	  0.018041, 0.017595, 0.014262, 0.009471, 0.004258, 0.006440, 0.011106, 0.016153, 0.017866, 0.017483, 0.015724, 0.015049, 0.014353, 0.010330, 0.008195, 0.007865, 0.008212, 0.004923, 0.001547, -0.000577, 0.002029, 0.008719, 0.017251, 0.023863, 0.025247
#*# 	  0.008909, 0.015173, 0.011992, 0.003879, -0.000070, 0.002353, 0.005788, 0.012219, 0.013771, 0.011232, 0.007464, 0.006414, 0.004891, 0.000986, 0.000273, 0.000129, 0.000652, -0.003148, -0.004220, -0.006803, -0.006507, 0.002898, 0.010585, 0.016776, 0.016623
#*# 	  -0.000276, 0.006275, 0.005418, -0.000976, -0.005600, -0.004137, 0.000373, 0.006536, 0.006479, 0.002713, 0.000202, -0.000534, -0.002268, -0.003389, -0.003921, -0.005564, -0.004864, -0.005362, -0.008623, -0.013170, -0.012310, -0.002970, 0.005257, 0.009716, 0.010417
#*# 	  -0.009066, -0.005871, -0.003753, -0.007757, -0.013296, -0.011296, -0.003084, 0.000839, -0.000477, -0.004269, -0.006160, -0.007817, -0.009494, -0.011509, -0.012899, -0.014018, -0.011433, -0.012632, -0.017999, -0.021355, -0.019094, -0.009826, -0.002227, 0.003174, 0.003254
#*# 	  -0.010209, -0.006393, -0.007772, -0.009998, -0.010800, -0.009567, -0.005379, -0.000138, 0.000995, -0.000967, -0.004979, -0.006998, -0.008210, -0.009979, -0.011996, -0.012511, -0.013798, -0.016428, -0.018651, -0.021110, -0.020859, -0.011086, -0.002413, 0.001562, 0.009385
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 330.0
#*# min_y = 50.0
#*# max_y = 330.0
