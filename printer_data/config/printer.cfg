# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader", "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".

# See docs/Config_Reference.md for a description of parameters.

#=====================================================
# MACROS
#=====================================================
[include macros.cfg]
[include Fan.cfg]
[include TMC Autotune.cfg]
[exclude_object]
[include TEST_SPEED.cfg]
[include timelapse.cfg]
[include temp_sensors.cfg]
[include z_tilt.cfg]
[include beacon.cfg]
[include LED.cfg]
[include resonance_tester.cfg]
[include input_shaper.cfg]
[include AFC/*.cfg]

#=====================================================
# VIRTUAL SD CARD
#=====================================================
[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

#=====================================================
# MCU ID
#=====================================================
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3F003D001051313236343430-if00
[mcu EBBCan]
canbus_uuid: e75929009724
[mcu U2C]
canbus_uuid: 2246f0775ddc

####################################################################
# 	X/Y Stepper Settings
#####################################################################

########################################
# X Stepper on Motor1 (A Motor)
########################################
# Motor-1
[stepper_x]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan:PB5
position_endstop: 1
position_max: 377
homing_speed: 150

[tmc5160 stepper_x]
cs_pin: PG14
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# Y Stepper on Motor2 (B Motor)
########################################
# Motor-2
[stepper_y]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 16
rotation_distance: 40
endstop_pin: PF0
position_endstop: 370
position_max: 370
homing_speed: 150

[tmc5160 stepper_y]
cs_pin: PG13
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.4
interpolate: false
sense_resistor: 0.075

########################################
# STEPPER Z
########################################
# Motor-5 Rear Center
[stepper_z]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
endstop_pin: probe:z_virtual_endstop
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
position_max: 370
position_min: -4
homing_speed: 10
homing_retract_dist: 0

[tmc2209 stepper_z]
interpolate: false
uart_pin: PG10
run_current: 1.0
sense_resistor: 0.11

# Motor-6 Front Left 
[stepper_z1] 
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z1]
interpolate: false
uart_pin: PG9
run_current: 1.0
sense_resistor: 0.11

# motor-7 Front Right
[stepper_z2]
step_pin:PD3
dir_pin: PD2
enable_pin: !PD4
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2

[tmc2209 stepper_z2]
interpolate: false
uart_pin: PD7
run_current: 1.0
sense_resistor: 0.11


########################################
# EXTRUDER
########################################
[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 35.1
gear_ratio: 60:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: MAX31865
pwm_cycle_time: 0.00417
sensor_pin: EBBCan: PA4
spi_bus: spi1
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2
min_extrude_temp: 180
min_temp: 0
max_temp: 400
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
full_steps_per_rotation: 200
pressure_advance: 0.03
pressure_advance_smooth_time: 0.03
max_extrude_only_distance: 400 

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: true
run_current: 0.85 
sense_resistor: 0.11 
driver_HEND: 6
driver_HSTRT: 7

########################################
# BED MESH
########################################
[bed_mesh]
algorithm: bicubic
speed: 600
mesh_min: 50,50
mesh_max: 330,330
probe_count: 25,25

########################################
# IDLE TIMEOUT
########################################
[idle_timeout]
timeout: 172800

########################################
# HEATER BED
########################################
[heater_bed]
heater_pin: PA0
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_kp: 27
#pid_ki: 0.08
#pid_kd: 0
min_temp: 0
max_temp: 120

#=====================================================
# Force Move
#=====================================================
[force_move]
enable_force_move: True

#=====================================================
# PRINTER LIMITS
#=====================================================
[printer]
kinematics: corexy
max_velocity: 800
max_accel: 10000
max_z_velocity: 10
max_z_accel: 300
square_corner_velocity: 5.0

#=====================================================
# SHAKETUNE
#=====================================================
[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_version = 1
#*# pid_target = 290.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 19.556
#*# pid_ki = 2.155
#*# pid_kd = 44.371
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 30.789
#*# pid_ki = 0.901
#*# pid_kd = 263.053
#*#
#*# [beacon model default]
#*# model_coef = 1.5200098960095572,
#*# 	  1.8891676870706475,
#*# 	  0.7724155783727761,
#*# 	  0.22231295951561383,
#*# 	  0.341653484342424,
#*# 	  0.6434137855875988,
#*# 	  -0.1860445004270465,
#*# 	  -0.6938099960310649,
#*# 	  0.15200067924256747,
#*# 	  0.3419637989026288
#*# model_domain = 1.8580448662272507e-07,1.9350931161442987e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 36.133510
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.000689, -0.004604, -0.006198, -0.009306, -0.012714, -0.013893, -0.013877, -0.013795, -0.013693, -0.017296, -0.022292, -0.026409, -0.029070, -0.029837, -0.030101, -0.030106, -0.030743, -0.031106, -0.030967, -0.028648, -0.026105, -0.020445, -0.014652, -0.010044, 0.001886
#*# 	  0.007733, 0.003662, 0.002508, -0.003154, -0.004233, -0.009731, -0.007070, -0.008764, -0.009225, -0.012780, -0.016686, -0.018173, -0.021340, -0.023199, -0.022554, -0.021820, -0.021075, -0.021003, -0.020385, -0.017713, -0.015351, -0.009847, -0.002920, 0.003365, 0.008397
#*# 	  0.014617, 0.010771, 0.006951, 0.003762, 0.001016, -0.001010, -0.000984, -0.001243, -0.001664, -0.005687, -0.006154, -0.007548, -0.009611, -0.010973, -0.012593, -0.012477, -0.010516, -0.008884, -0.007522, -0.006905, -0.002794, 0.000862, 0.005074, 0.014426, 0.018758
#*# 	  0.022281, 0.021765, 0.019522, 0.016851, 0.012451, 0.012507, 0.010109, 0.008637, 0.004888, 0.003274, 0.003785, 0.002236, 0.003229, 0.001958, 0.001613, 0.001050, 0.003856, 0.001629, -0.000444, -0.001593, -0.000309, 0.004304, 0.010154, 0.018928, 0.027936
#*# 	  0.027171, 0.028836, 0.024358, 0.020123, 0.018995, 0.017031, 0.014444, 0.011430, 0.009160, 0.009787, 0.009962, 0.010873, 0.010200, 0.007083, 0.008901, 0.011315, 0.011807, 0.011767, 0.009013, 0.009129, 0.007268, 0.011486, 0.019615, 0.026754, 0.034825
#*# 	  0.026991, 0.025060, 0.023713, 0.021825, 0.021119, 0.020608, 0.018174, 0.014470, 0.012714, 0.010205, 0.013146, 0.015442, 0.015341, 0.013566, 0.014467, 0.017671, 0.016218, 0.016602, 0.013556, 0.010603, 0.008084, 0.011548, 0.020546, 0.027560, 0.035777
#*# 	  0.027751, 0.026203, 0.026065, 0.022270, 0.020992, 0.020788, 0.020624, 0.020484, 0.019489, 0.020720, 0.022505, 0.022959, 0.022206, 0.018771, 0.018107, 0.019904, 0.020217, 0.021789, 0.019004, 0.012629, 0.015413, 0.015373, 0.019247, 0.026116, 0.031650
#*# 	  0.023371, 0.026607, 0.023302, 0.023792, 0.024250, 0.024438, 0.024090, 0.025045, 0.023047, 0.025862, 0.026849, 0.030040, 0.031233, 0.030379, 0.030105, 0.029638, 0.030104, 0.025854, 0.022026, 0.016611, 0.013628, 0.015358, 0.020846, 0.028598, 0.034864
#*# 	  0.031102, 0.028769, 0.025903, 0.022783, 0.021062, 0.022530, 0.025726, 0.028080, 0.032112, 0.032556, 0.035422, 0.036623, 0.033688, 0.030558, 0.030910, 0.029013, 0.029021, 0.028152, 0.027369, 0.026282, 0.020388, 0.022060, 0.024447, 0.029402, 0.035180
#*# 	  0.027492, 0.025253, 0.026878, 0.024712, 0.023035, 0.025949, 0.027962, 0.031082, 0.030061, 0.028572, 0.030564, 0.031412, 0.033077, 0.033015, 0.033973, 0.033236, 0.031126, 0.032460, 0.026238, 0.025286, 0.024319, 0.025660, 0.028480, 0.034924, 0.041205
#*# 	  0.032727, 0.031669, 0.028166, 0.024495, 0.022510, 0.025359, 0.028986, 0.035287, 0.036024, 0.035628, 0.035031, 0.033712, 0.032378, 0.031842, 0.030379, 0.031390, 0.032427, 0.033041, 0.031332, 0.031011, 0.031064, 0.031655, 0.036109, 0.037093, 0.042537
#*# 	  0.027737, 0.028535, 0.029231, 0.027200, 0.027548, 0.030043, 0.032672, 0.033637, 0.034286, 0.033136, 0.030807, 0.030035, 0.031221, 0.031985, 0.034386, 0.038800, 0.035350, 0.033565, 0.031777, 0.031064, 0.028747, 0.030794, 0.036413, 0.040601, 0.046474
#*# 	  0.032463, 0.029319, 0.024177, 0.021364, 0.020312, 0.024213, 0.028833, 0.036048, 0.038222, 0.037930, 0.035209, 0.032271, 0.029405, 0.025022, 0.028252, 0.031515, 0.032136, 0.034222, 0.032910, 0.033414, 0.032309, 0.035196, 0.032735, 0.041180, 0.039086
#*# 	  0.028071, 0.028671, 0.025981, 0.025319, 0.024575, 0.029059, 0.033710, 0.036694, 0.034600, 0.032929, 0.029002, 0.027865, 0.029131, 0.031881, 0.033673, 0.031539, 0.030999, 0.027340, 0.024119, 0.023018, 0.021819, 0.024861, 0.027448, 0.033179, 0.040341
#*# 	  0.033139, 0.028986, 0.025119, 0.019061, 0.020542, 0.026674, 0.032966, 0.037401, 0.040842, 0.040538, 0.038580, 0.036601, 0.030996, 0.030710, 0.027805, 0.026411, 0.023676, 0.024049, 0.023593, 0.024702, 0.023165, 0.025076, 0.029429, 0.030505, 0.036380
#*# 	  0.027506, 0.022564, 0.028485, 0.022822, 0.024446, 0.029801, 0.034998, 0.037613, 0.037090, 0.033219, 0.032022, 0.032660, 0.030562, 0.034708, 0.033808, 0.035138, 0.026774, 0.023943, 0.019996, 0.016049, 0.015766, 0.018852, 0.024831, 0.031723, 0.036627
#*# 	  0.027973, 0.023996, 0.019836, 0.014540, 0.013962, 0.020611, 0.025956, 0.033200, 0.035892, 0.035208, 0.035086, 0.034420, 0.030530, 0.025397, 0.024143, 0.020257, 0.017044, 0.015534, 0.013235, 0.012486, 0.013683, 0.015840, 0.018124, 0.021416, 0.023228
#*# 	  0.023064, 0.025142, 0.012985, 0.015773, 0.015962, 0.021128, 0.026241, 0.027971, 0.026240, 0.024499, 0.023245, 0.023825, 0.026404, 0.026959, 0.027434, 0.021859, 0.020703, 0.011593, 0.007008, 0.006277, 0.004027, 0.008015, 0.013261, 0.018421, 0.023667
#*# 	  0.028593, 0.023043, 0.018205, 0.010366, 0.012051, 0.017180, 0.021751, 0.026073, 0.029181, 0.030166, 0.029618, 0.027826, 0.024240, 0.019796, 0.018724, 0.014717, 0.009033, 0.009988, 0.010314, 0.010683, 0.008236, 0.011360, 0.012574, 0.019238, 0.017412
#*# 	  0.022165, 0.020699, 0.020210, 0.016185, 0.016154, 0.020139, 0.022827, 0.023448, 0.021570, 0.019129, 0.018539, 0.018694, 0.017601, 0.020670, 0.018885, 0.017436, 0.010718, 0.004435, 0.002146, -0.000486, 0.001145, 0.002157, 0.008521, 0.013454, 0.019580
#*# 	  0.021881, 0.015976, 0.010369, 0.005439, 0.004586, 0.007495, 0.011536, 0.015196, 0.019608, 0.021876, 0.019421, 0.017205, 0.012821, 0.005504, 0.002742, 0.002092, -0.000996, -0.001781, -0.002630, -0.001112, -0.000799, 0.000316, 0.001394, 0.002161, 0.008012
#*# 	  0.006870, 0.011148, 0.009146, 0.008279, 0.009418, 0.011043, 0.010410, 0.010710, 0.008745, 0.005720, 0.002777, 0.002111, 0.006070, 0.002319, 0.002623, 0.002451, -0.003185, -0.009182, -0.013394, -0.013156, -0.018971, -0.012447, -0.007841, -0.001285, 0.007315
#*# 	  0.005156, 0.004935, 0.000550, -0.004634, -0.008684, -0.005148, -0.001567, 0.000871, 0.007771, 0.005350, 0.004634, 0.000218, -0.004011, -0.010544, -0.011670, -0.013606, -0.018760, -0.014636, -0.015583, -0.015858, -0.016284, -0.012139, -0.016562, -0.007981, -0.006646
#*# 	  -0.008731, -0.002207, -0.006338, -0.005055, -0.004168, -0.001200, -0.002317, -0.002033, -0.006692, -0.009831, -0.010668, -0.010774, -0.010839, -0.007283, -0.012052, -0.015107, -0.018025, -0.023537, -0.029564, -0.031948, -0.031954, -0.028228, -0.020803, -0.013956, -0.007182
#*# 	  -0.000644, -0.006823, -0.008427, -0.013524, -0.009831, -0.011381, -0.007326, -0.002879, 0.001455, 0.000675, -0.001942, -0.005524, -0.010562, -0.012869, -0.020310, -0.022662, -0.025766, -0.027898, -0.031611, -0.023966, -0.024591, -0.022699, -0.020446, -0.015583, -0.012541
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 330.0
#*# min_y = 50.0
#*# max_y = 330.0
