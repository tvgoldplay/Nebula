import{o as C}from"./index-cf5a13a6.js";import{B as P,a as S,f as D,h as B,P as U,I as z,c as G,V as m}from"./Viewer-cef512b1.js";import{C as V}from"./cubemapToSphericalPolynomial-7b064401.js";import"./vuetify-efafe15a.js";import"./overlayscrollbars-44d87bcf.js";import"./echarts-ff51454d.js";import"./codemirror-0a1db0c7.js";P.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(P.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=V.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const O="image/png",I=2,M=[134,22,135,150,246,214,150,54];function k(e){const a=new DataView(e.buffer,e.byteOffset,e.byteLength);let t=0;for(let l=0;l<M.length;l++)if(a.getUint8(t++)!==M[l])return S.Error("Not a babylon environment map"),null;let r="",n=0;for(;n=a.getUint8(t++);)r+=String.fromCharCode(n);let o=JSON.parse(r);return o=A(o),o.specular&&(o.specular.specularDataPosition=t,o.specular.lodGenerationScale=o.specular.lodGenerationScale||.8),o}function A(e){if(e.version>I)throw new Error('Unsupported babylon environment map version "'.concat(e.version,'". Latest supported version is "').concat(I,'".'));return e.version===2||(e={...e,version:2,imageType:O}),e}function E(e,a){a=A(a);const t=a.specular;let r=Math.log2(a.width);if(r=Math.round(r)+1,t.mipmaps.length!==6*r)throw new Error('Unsupported specular mipmaps number "'.concat(t.mipmaps.length,'"'));const n=new Array(r);for(let o=0;o<r;o++){n[o]=new Array(6);for(let l=0;l<6;l++){const s=t.mipmaps[o*6+l];n[o][l]=new Uint8Array(e.buffer,e.byteOffset+t.specularDataPosition+s.position,s.length)}}return n}function H(e,a,t){t=A(t);const r=t.specular;if(!r)return Promise.resolve();e._lodGenerationScale=r.lodGenerationScale;const n=E(a,t);return N(e,n,t.imageType)}function F(e,a,t,r,n,o,l,s,h,_,y){return new Promise((x,v)=>{if(t){const i=a.createTexture(null,!0,!0,null,1,null,u=>{v(u)},e);r==null||r.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{r.externalTextureSamplerBinding=!0,r.onApply=p=>{p._bindTexture("textureSampler",i),p.setFloat2("scale",1,a._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},a.scenes.length&&(a.scenes[0].postProcessManager.directRender([r],_,!0,o,l),a.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(n),x())})})}else{if(a._uploadImageToTexture(y,e,o,l),s){const i=h[l];i&&a._uploadImageToTexture(i._texture,e,o,0)}x()}})}async function N(e,a,t=O){if(!D.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const r=B(e.width)+1,n=e.getEngine();let o=!1,l=!1,s=null,h=null,_=null;const y=n.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),y.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?y.textureHalfFloatRender&&y.textureHalfFloatLinearFiltering?(o=!0,e.type=2):y.textureFloatRender&&y.textureFloatLinearFiltering&&(o=!0,e.type=1):o=!1:(o=!1,l=!0,_={});let x=0;if(o)n.isWebGPU?(x=1,await C(()=>import("./rgbdDecode.fragment-4166c1a0.js"),["assets/rgbdDecode.fragment-4166c1a0.js","assets/Viewer-cef512b1.js","assets/index-cf5a13a6.js","assets/vuetify-efafe15a.js","assets/vuetify-950d1cb0.css","assets/overlayscrollbars-44d87bcf.js","assets/overlayscrollbars-a16bc3d3.css","assets/echarts-ff51454d.js","assets/index-83a57274.css","assets/codemirror-0a1db0c7.js","assets/Viewer-46526977.css"])):await C(()=>import("./rgbdDecode.fragment-9a9d6a38.js"),["assets/rgbdDecode.fragment-9a9d6a38.js","assets/Viewer-cef512b1.js","assets/index-cf5a13a6.js","assets/vuetify-efafe15a.js","assets/vuetify-950d1cb0.css","assets/overlayscrollbars-44d87bcf.js","assets/overlayscrollbars-a16bc3d3.css","assets/echarts-ff51454d.js","assets/index-83a57274.css","assets/codemirror-0a1db0c7.js","assets/Viewer-46526977.css","assets/helperFunctions-f8fbed2c.js"]),s=new U("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,e.type,void 0,null,!1,void 0,x),e._isRGBD=!1,e.invertY=!1,h=n.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,l){const u=e._lodGenerationScale,p=e._lodGenerationOffset;for(let c=0;c<3;c++){const g=1-c/2,f=p,L=(r-1)*u+p,R=f+(L-f)*g,w=Math.round(Math.min(Math.max(R,0),L)),b=new z(n,2);b.isCube=!0,b.invertY=!0,b.generateMipMaps=!1,n.updateTextureSamplingMode(2,b);const T=new P(null);switch(T._isCube=!0,T._texture=b,_[w]=T,c){case 0:e._lodTextureLow=T;break;case 1:e._lodTextureMid=T;break;case 2:e._lodTextureHigh=T;break}}}const v=[];for(let i=0;i<a.length;i++)for(let u=0;u<6;u++){const p=a[i][u],c=new Blob([p],{type:t}),d=URL.createObjectURL(c);let g;if(n._features.forceBitmapOverHTMLImageElement)g=n.createImageBitmap(c,{premultiplyAlpha:"none"}).then(f=>F(f,n,o,s,d,u,i,l,_,h,e));else{const f=new Image;f.src=d,g=new Promise((L,R)=>{f.onload=()=>{F(f,n,o,s,d,u,i,l,_,h,e).then(()=>L()).catch(w=>{R(w)})},f.onerror=w=>{R(w)}})}v.push(g)}if(a.length<r){let i;const u=Math.pow(2,r-1-a.length),p=u*u*4;switch(e.type){case 0:{i=new Uint8Array(p);break}case 2:{i=new Uint16Array(p);break}case 1:{i=new Float32Array(p);break}}for(let c=a.length;c<r;c++)for(let d=0;d<6;d++)n._uploadArrayBufferViewToTexture(e,i,d,c)}return Promise.all(v).then(()=>{h&&(n._releaseTexture(e),h._swapAndDie(e)),s&&s.dispose(),l&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})}function Y(e,a){a=A(a);const t=a.irradiance;if(!t)return;const r=new G;m.FromArrayToRef(t.x,0,r.x),m.FromArrayToRef(t.y,0,r.y),m.FromArrayToRef(t.z,0,r.z),m.FromArrayToRef(t.xx,0,r.xx),m.FromArrayToRef(t.yy,0,r.yy),m.FromArrayToRef(t.zz,0,r.zz),m.FromArrayToRef(t.yz,0,r.yz),m.FromArrayToRef(t.zx,0,r.zx),m.FromArrayToRef(t.xy,0,r.xy),e._sphericalPolynomial=r}class X{constructor(){this.supportCascades=!1}loadCubeData(a,t,r,n,o){if(Array.isArray(a))return;const l=k(a);if(l){t.width=l.width,t.height=l.width;try{Y(t,l),H(t,a,l).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()},s=>{o==null||o("Can not upload environment levels",s)})}catch(s){o==null||o("Can not upload environment file",s)}}else o&&o("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}export{X as _ENVTextureLoader};
