import{m as d,B as g,H as f,J as _,P as h,W as p,C as S,R as v,n as y}from"./index-cf5a13a6.js";import{_ as u}from"./WebcamNozzleCrosshair-1b1f52e2.js";import{l as C,m as w,q as b}from"./vuetify-efafe15a.js";import"./overlayscrollbars-44d87bcf.js";import"./echarts-ff51454d.js";var T=Object.defineProperty,x=Object.getOwnPropertyDescriptor,o=(s,t,e,r)=>{for(var a=r>1?void 0:r?x(t,e):t,c=s.length-1,l;c>=0;c--)(l=s[c])&&(a=(r?l(t,e,a):l(a))||a);return r&&a&&T(t,e,a),a};let i=class extends d(g,f){constructor(){super(...arguments),this.capitalize=_,this.pc=null,this.useStun=!1,this.aspectRatio=null,this.status="connecting",this.restartTimer=null}get url(){var t;return this.convertUrl((t=this.camSettings)==null?void 0:t.stream_url,this.printerUrl)}get webcamStyle(){var e,r,a;const t={transform:this.generateTransform((e=this.camSettings.flip_horizontal)!=null?e:!1,(r=this.camSettings.flip_vertical)!=null?r:!1,(a=this.camSettings.rotation)!=null?a:0),aspectRatio:1.7777777777777777};return this.aspectRatio&&(t.aspectRatio=this.aspectRatio),t}get nozzleCrosshair(){var t,e;return(e=(t=this.camSettings.extra_data)==null?void 0:t.nozzleCrosshair)!=null?e:!1}get expanded(){var t;return this.page!=="dashboard"?!0:(t=this.$store.getters["gui/getPanelExpand"]("webcam-panel",this.viewport))!=null?t:!1}expandChanged(t){if(!t){this.terminate();return}this.start()}async start(){if(this.restartTimer&&(this.log("Clearing restart timer before starting stream"),window.clearTimeout(this.restartTimer)),!this.expanded){this.log("Not expanded, not starting stream");return}this.log("Requesting ICE servers from ".concat(this.url));try{const t=this.useStun?[{urls:["stun:stun.l.google.com:19302"]}]:null,e=await fetch(this.url,{body:JSON.stringify({type:"request",iceServers:t}),method:"POST"});if(e.status!==200){this.log("Failed to start stream: ".concat(e.status)),this.restartStream();return}const r=await e.json();await this.onIceServers(r)}catch(t){this.log("Failed to start stream",t)}}async onIceServers(t){var c,l;this.pc&&this.pc.close();let e={iceServers:(c=t.iceServers)!=null?c:[],sdpSemantics:"unified-plan"};this.pc=new RTCPeerConnection(e),this.pc.addTransceiver("video",{direction:"recvonly"}),"iceServers"in t?this.pc.onicecandidate=n=>this.onIceCandidate(n,t.id):this.log("No ICE servers returned, so the current camera-streamer version may not support them"),this.pc.onconnectionstatechange=()=>this.onConnectionStateChange(),this.pc.ontrack=n=>this.onTrack(n),await((l=this.pc)==null?void 0:l.setRemoteDescription(t));const r=await this.pc.createAnswer();await this.pc.setLocalDescription(r);const a=this.pc.localDescription;if(!a){this.log("Failed to create offer"),this.restartStream();return}try{const n=await fetch(this.url,{body:JSON.stringify({type:a==null?void 0:a.type,id:t.id,sdp:a==null?void 0:a.sdp}),headers:{"Content-Type":"application/json"},method:"POST"});n.status!==200&&(this.log("Failed to send offer: ".concat(n.status)),this.restartStream())}catch(n){this.log("Failed to send offer",n),this.restartStream()}}async onIceCandidate(t,e){if(t.candidate)try{const r=await fetch(this.url,{body:JSON.stringify({id:e,type:"remote_candidate",candidates:[t.candidate]}),headers:{"Content-Type":"application/json"},method:"POST"});r.status!==200&&(this.log("Failed to send ICE candidate: ".concat(r.status)),this.restartStream())}catch(r){this.log("Failed to send ICE candidate",r),this.restartStream()}}onConnectionStateChange(){var t,e;this.status=(e=(t=this.pc)==null?void 0:t.connectionState)!=null?e:"connecting",this.log("State: ".concat(this.status)),["failed","disconnected"].includes(this.status)&&this.restartStream(5e3)}onTrack(t){t.track.kind==="video"&&(this.stream.srcObject=t.streams[0])}log(t,e){const r="[WebRTC camera-streamer] ".concat(t);if(e){window.console.log(r,e);return}window.console.log(r)}beforeDestroy(){this.terminate(),this.restartTimer&&window.clearTimeout(this.restartTimer)}terminate(){var t;this.log("Terminating stream"),(t=this.pc)==null||t.close()}restartStream(t=500){this.terminate(),!this.restartTimer&&(this.restartTimer=window.setTimeout(async()=>{this.restartTimer=null,await this.start()},t))}changedUrl(){this.restartStream()}};o([h({required:!0})],i.prototype,"camSettings",2);o([h({default:null})],i.prototype,"printerUrl",2);o([h({type:String,default:null})],i.prototype,"page",2);o([v()],i.prototype,"stream",2);o([p("expanded",{immediate:!0})],i.prototype,"expandChanged",1);o([p("url")],i.prototype,"changedUrl",1);i=o([S({components:{WebcamNozzleCrosshair:u}})],i);var z=function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("div",{staticClass:"position-relative d-flex"},[e("video",{directives:[{name:"show",rawName:"v-show",value:s.status==="connected",expression:"status === 'connected'"}],ref:"stream",staticClass:"webcamStream",style:s.webcamStyle,attrs:{autoplay:"",muted:"",playsinline:""},domProps:{muted:!0}}),s.nozzleCrosshair?e(u,{attrs:{webcam:s.camSettings}}):s._e(),s.status!=="connected"?e(C,[e(w,{staticClass:"_webcam_webrtc_output text-center d-flex flex-column justify-center align-center"},[s.status==="connecting"?e(b,{staticClass:"mb-3",attrs:{indeterminate:"",color:"primary"}}):s._e(),e("span",{staticClass:"mt-3"},[s._v(s._s(s.capitalize(s.status)))])],1)],1):s._e()],1)},P=[];const m={};var O=y(i,z,P,!1,I,"1913eac3",null,null);function I(s){for(let t in m)this[t]=m[t]}const D=function(){return O.exports}();export{D as default};
