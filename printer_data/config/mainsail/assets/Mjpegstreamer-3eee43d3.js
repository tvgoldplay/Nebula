import{m as S,B as w,H as y,P as u,W as _,R as v,C as b,n as C}from"./index-cf5a13a6.js";import{_ as x}from"./WebcamNozzleCrosshair-1b1f52e2.js";import{l as P,m as R,q as F}from"./vuetify-efafe15a.js";import"./overlayscrollbars-44d87bcf.js";import"./echarts-ff51454d.js";var L=Object.defineProperty,M=Object.getOwnPropertyDescriptor,n=(s,t,e,r)=>{for(var a=r>1?void 0:r?M(t,e):t,o=s.length-1,l;o>=0;o--)(l=s[o])&&(a=(r?l(t,e,a):l(a))||a);return r&&a&&L(t,e,a),a};const j="content-length",m=new Uint8Array(2);m[0]=255;m[1]=216;let i=class extends S(w,y){constructor(){super(),this.frames=0,this.currentFPS=0,this.status="connecting",this.statusMessage="",this.streamState=!1,this.aspectRatio=null,this.timerFPS=null,this.timerRestart=null,this.reader=null}get url(){var t;return this.convertUrl((t=this.camSettings)==null?void 0:t.stream_url,this.printerUrl)}get webcamStyle(){var e,r,a;const t={transform:this.generateTransform((e=this.camSettings.flip_horizontal)!=null?e:!1,(r=this.camSettings.flip_vertical)!=null?r:!1,(a=this.camSettings.rotation)!=null?a:0),aspectRatio:1.7777777777777777,maxHeight:window.innerHeight-155+"px",maxWidth:"auto"};return this.aspectRatio&&(t.aspectRatio=this.aspectRatio,t.maxWidth=(window.innerHeight-155)*this.aspectRatio+"px"),t}get fpsOutput(){return this.currentFPS.toString().padStart(2,"0")}get showFpsCounter(){var t,e;return this.showFps?!((e=(t=this.camSettings.extra_data)==null?void 0:t.hideFps)!=null&&e):!1}get expanded(){var t;return this.page!=="dashboard"?!0:(t=this.$store.getters["gui/getPanelExpand"]("webcam-panel",this.viewport))!=null?t:!1}get showNozzleCrosshair(){var e,r;return((r=(e=this.camSettings.extra_data)==null?void 0:e.nozzleCrosshair)!=null?r:!1)&&this.status==="connected"}expandChanged(t){if(!t){this.stopStream();return}this.startStream()}log(t,e){if(e){window.console.log("[MJPEG streamer] ".concat(t),e);return}window.console.log("[MJPEG streamer] ".concat(t))}getLength(t){let e=-1;return t.split("\n").forEach(r=>{const a=r.split(":");a[0].toLowerCase()===j&&(e=a[1])}),e}async startStream(t=!1){var e;if(!this.streamState){this.streamState=!0,t||(this.status="connecting",this.statusMessage=this.$t("Panels.WebcamPanel.ConnectingTo",{url:this.url}).toString()),this.clearTimeouts();try{const r=new URL(this.url);r.searchParams.append("timestamp",new Date().getTime().toString());let a=await fetch(r.toString(),{mode:"cors"});if(!a.ok){this.log("".concat(a.status,": ").concat(a.statusText)),await this.stopStream();return}if(!a.body){this.log("ReadableStream not yet supported in this browser."),await this.stopStream();return}this.timerFPS=window.setInterval(()=>{this.currentFPS=this.frames,this.frames=0},1e3),this.timerRestart=window.setTimeout(()=>{this.restartStream(!0)},1e4),this.reader=(e=a.body)==null?void 0:e.getReader(),await this.readStream(),this.reader=null,a=null}catch(r){this.log(r.message),this.status="error",this.statusMessage=this.$t("Panels.WebcamPanel.ErrorWhileConnecting",{url:this.url}).toString(),this.timerRestart=window.setTimeout(()=>{this.restartStream()},5e3)}}}async readStream(){var t,e;if(this.reader)try{let r="",a=-1,o=new Uint8Array(0),l=0,p=!1,g=null,c;do if({done:g,value:c}=await this.reader.read(),!(g||!c))for(let h=0;h<c.length;h++){if(c[h]===m[0]&&c[h+1]===m[1]&&(a=this.getLength(r),o=new Uint8Array(new ArrayBuffer(a))),a<=0){r+=String.fromCharCode(c[h]);continue}if(l<a){o[l++]=c[h];continue}if(this.image&&!p){const d=URL.createObjectURL(new Blob([o],{type:"image/jpeg"}));this.image.src=d,p=!0,this.status!=="connected"&&(this.status="connected",this.statusMessage=""),this.image.onload=()=>{URL.revokeObjectURL(d),p=!1}}this.frames++,a=0,l=0,r=""}while(!g)}catch(r){this.log("readStream error: ".concat((t=r.message)!=null?t:""),r)}finally{(e=this.reader)==null||e.releaseLock()}}mounted(){document.addEventListener("visibilitychange",this.documentVisibilityChanged)}beforeDestroy(){document.removeEventListener("visibilitychange",this.documentVisibilityChanged),this.stopStream()}clearTimeouts(){this.frames=0,this.timerFPS&&(window.clearInterval(this.timerFPS),this.timerFPS=null),this.timerRestart&&(window.clearTimeout(this.timerRestart),this.timerRestart=null)}async stopStream(t=!1){var e,r;this.streamState=!1,t||(this.status="disconnected",this.statusMessage=this.$t("Panels.WebcamPanel.Disconnected").toString()),this.clearTimeouts();try{await((e=this.reader)==null?void 0:e.cancel()),(r=this.reader)==null||r.releaseLock(),this.reader=null}catch(a){this.log("Error cancelling reader:",a)}}async restartStream(t=!1){await this.stopStream(t),await this.startStream(t)}camSettingsChanged(){this.aspectRatio=null,this.restartStream()}documentVisibilityChanged(){let e=document.visibilityState==="visible";if(this.page==="dashboard"&&!this.expanded&&(e=!1),!e){this.stopStream();return}this.startStream()}onload(){this.aspectRatio!==null||!this.image||(this.aspectRatio=this.image.naturalWidth/this.image.naturalHeight)}};n([u({required:!0})],i.prototype,"camSettings",2);n([u({default:null})],i.prototype,"printerUrl",2);n([u({default:!0})],i.prototype,"showFps",2);n([u({type:String,default:null})],i.prototype,"page",2);n([v("image")],i.prototype,"image",2);n([_("expanded",{immediate:!0})],i.prototype,"expandChanged",1);n([_("camSettings",{deep:!0})],i.prototype,"camSettingsChanged",1);i=n([b],i);var T=function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("div",{staticClass:"d-flex justify-center",staticStyle:{position:"relative"}},[e("img",{directives:[{name:"show",rawName:"v-show",value:s.status==="connected",expression:"status === 'connected'"}],ref:"image",staticClass:"webcamImage",style:s.webcamStyle,attrs:{draggable:"false",alt:s.camSettings.name,src:"#"},on:{load:s.onload}}),s.showFpsCounter&&s.status==="connected"?e("span",{staticClass:"webcamFpsOutput"},[s._v(" "+s._s(s.$t("Panels.WebcamPanel.FPS"))+": "+s._s(s.fpsOutput)+" ")]):s._e(),s.showNozzleCrosshair?e(x,{attrs:{webcam:s.camSettings}}):s._e(),s.status!=="connected"?e(P,[e(R,{staticClass:"_webcam_mjpegstreamer_output text-center d-flex flex-column justify-center align-center"},[s.status==="connecting"?e(F,{staticClass:"mb-3",attrs:{indeterminate:"",color:"primary"}}):s._e(),e("span",{staticClass:"mt-3"},[s._v(s._s(s.statusMessage))])],1)],1):s._e()],1)},z=[];const f={};var U=C(i,T,z,!1,$,"0a43b880",null,null);function $(s){for(let t in f)this[t]=f[t]}const D=function(){return U.exports}();export{D as default};
